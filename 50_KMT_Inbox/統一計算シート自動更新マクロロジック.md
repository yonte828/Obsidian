`[[CalcModule.bas]]`の`[[Mainプロシージャ]]`を中心とした処理内容の詳細な分析結果です。 このツールは、**「[[統一計算シート]]（[[Excel]]）」に記載された[[建設機械]]の[[部品情報]]を読み取り、外部システム（[[GDMS]]）へ問い合わせて最新の[[質量情報]]を取得・反映し、更新前後の差異を比較・報告する[[自動化ツール]]**です。

[[Pythonとは|Pythonへの移行]]（F/S）に向けた、[[処理フロー]]と[[機能要件]]の分解は以下の通りです。

---

### 1. 処理の全体像 (ハイレベルフロー)

処理は大きく分けて以下のフェーズで進行します。

1.  [[初期化・設定]]: 対象ファイルの特定とローカルへのコピー。
    
2.  [[事前準備]]: 対象[[Excelファイル]]のフォーマット補正。
    
3.  [[データ取得]]（更新前）: 現在のシート状態から計算値を退避。
    
4.  [[APIとは|API連携]]: [[GDMS]]サーバーへ問い合わせ、最新の[[質量データ]]を取得。
    
5.  [[データ反映・再計算]]: [[Excel]]に値を書き込み、[[Excel数式]]による再計算を実施。
    
6.  [[データ取得]]（更新後）: 更新後の計算値を取得。
    
7.  [[比較・詳細分析]]: 更新前後の値を比較し、差異があれば詳細レポートを作成。
    
8.  [[結果通知]]: メール送信とログ記録。
    

---

### 2. `Sub Main()` の詳細ステップ分解

`[[CalcModule.bas]]` のコードに基づいた詳細な挙動です。

#### Phase 1: 初期化と対象特定

-   [[設定読み込み]]: `[[InitializeSetting]]` で「[[更新履歴]]」シートと「[[機種一覧]]」シートを照合し、今回処理すべき対象ファイル（`[[targetWbPath]]`）と対象シート（`[[targetWsName]]`）を決定します。
    
-   [[存在チェック]]: `[[CheckIfSheetExistsInWorkbook]]` で、対象の[[Excelファイル]]とシートが実在するか確認します。存在しない場合はエラーメールを送信して終了します。
    

#### Phase 2: ファイル準備（バックアップとローカルコピー）

-   [[フォーマット補正]]: `[[VerUpTouitsuKeisanSheet]]` を呼び出し、対象ファイルが古いフォーマットの場合、必要な列やフラグ（「[[自動更新除外]]」列など）を追加して保存します。
    
-   [[作業フォルダ作成]]: `[[CreateFolderWithDateAndCopyWithDate]]` で、日付付きの作業フォルダを作成し、対象の[[Excelファイル]]をローカルにコピーします。ファイル名には「【質量更新後】」というプレフィックスが付与されます。同時に[[バックアップファイル]]も作成されます。
    

#### Phase 3: データスクレイピング（更新前）

-   [[品番リスト取得]]: `[[GetUpdatePNList]]` で、[[Excelシート]]から更新対象となる[[部品番号]]（PN）のリストを抽出します。この際、「[[質量DB]]」というテンプレートシートをコピーして利用します。
    
-   [[現状値の保存]]: `[[CreateDataList]]` を実行し、[[Excel]]上の特定の計算結果（[[機械総質量]]、[[接地圧]]、[[重心位置]]など）をメモリ上（[[Collection]]）に保存します（これを`compareListBefore`とします）。
    

#### Phase 4: 外部システム連携 (GDMS API)

-   [[APIリクエスト]]: `[[GDMSrequest]]` で、抽出した[[部品番号]]リストをもとに、[[社内サーバー]]（`http://10.2.3.154:37001...`）へ[[HTTP POSTリクエスト]]を送信します。
    
-   [[JSONパース]]: レスポンス（[[JSON形式]]）を `[[JsonConverter.bas]]` を使用してパースし、最新の[[質量]]、[[RV]]（[[リビジョン]]）、[[更新日時]]などを取得します。通信エラー時はリトライ処理（最大3回）を行います。
    

#### Phase 5: Excel更新と再計算

-   [[DBシート更新]]: `[[UpdateDataTableSheet]]` で、取得した[[APIデータ]]を[[Excel]]内の「[[質量DB]]」シートに書き込みます。
    
-   [[機種シート更新]]: `[[UpdateKisyuSheet]]` で、メインの[[計算シート]]（[[機種シート]]）の該当セル（Q列など）に新しい[[質量]]を書き込みます。
    
    -   **重要**: ここで[[Excelの自動計算機能]]が働き、他のセル（[[総質量]]など）の値が連動して変化することを期待しています。
        

#### Phase 6: データスクレイピング（更新後）と差異比較

-   [[更新後値の取得]]: 再度 `[[CreateDataList]]` を実行し、[[Excel]]再計算後の値をメモリ上に取得します（`compareListAfter`）。
    
-   [[比較処理]]: `[[UpdateHikakuSheet]]` で、「[[Hikaku]]」シートを生成し、Before/Afterの値を並べて記載します。
    
    -   `[[CompareMultipleValues]]` で差異判定を行います（例: 1%以上の変動があるか、など）。
        
    -   差異がある場合、該当セルを赤字にし、`[[DiffMeibanList]]`（差異があった銘板リスト）に追加します。
        

#### Phase 7: 詳細分析 (差異がある場合のみ)

-   [[詳細比較]]: `[[SpecCompareMain]]` が呼ばれます。
    
    -   [[バックアップファイル]]（更新前）と現在のファイル（更新後）を開き、`[[Hikaku_detail]]`シートを作成して、具体的にどの部品の変更が影響したのかという詳細な内訳を書き出します 。
        

#### Phase 8: 完了処理

-   [[メール送信]]: `[[SendMail]]` で、処理結果（成功/失敗、差異の有無）を[[Outlook]]経由でメール送信します。エラー発生時はログファイルも添付されます。
    
-   [[履歴更新]]: `[[UpdateHistorySheet]]` で、[[マクロブック]]の「[[更新履歴]]」テーブルに実行結果を追記します。
    
-   [[終了]]: 開いたワークブックを保存・クローズします。
    

---

### 3. [[Pythonとは|Python移行]]に向けた技術的検討事項 (F/Sのポイント)

この[[VBAとは|VBA]]を[[Pythonとは|Python]]に移行する際、以下のポイントが重要になります。

#### A. [[Excelの「再計算機能」への依存度]] (最重要)

このツールは、**「値を書き込んだ後、[[Excelの数式]]が再計算した結果を取得する」**という処理を行っています。

-   **課題**: [[Pythonとは|Python]]の一般的なライブラリ（[[pandasとは|pandas]]、[[openpyxl]]）は、[[Excelの数式エンジン]]を持っていません。値を書き込んでも、その結果（例：[[総質量]]）は自動で計算されません。
    
-   **解決策**:
    
    1.  [[Excel操作ライブラリ]]の利用: `[[xlwingsとは|xlwings]]` や `[[pywin32]]` (`[[win32com]]`) を使用して、バックグラウンドで実際に[[Excelアプリケーション]]を起動・操作する必要があります。
        
    2.  [[計算ロジックの移植]]: [[Excel]]側の計算式（[[総質量]]や[[重心計算]]など）をすべて解析し、[[Pythonとは|Python]]側で[[計算ロジック]]を実装します。（[[Excel依存]]を脱却できますが、工数は増大します）
        

#### B. [[APIとは|API連携]]

-   `[[GDMSrequest]]` は `[[MSXML2.XMLHTTP60]]` を使用しています。
    
-   [[Pythonとは|Python]]の `[[requestsライブラリとは|requests]]` ライブラリに置き換えることで、よりシンプルかつ堅牢に実装可能です。
    

#### C. [[メーラー連携]]

-   `[[SendMail]]` は [[Outlookオブジェクトモデル]]を使用しています。
    
-   [[Pythonとは|Python]]でも `[[pywin32]]` で[[Outlook]]を操作するか、[[SMTP]] (`[[smtplib]]`) を使用して直接メールサーバーから送信する方法に切り替える必要があります。
    

#### D. [[ファイル・フォルダ操作]]

-   `[[Module2]]` や `[[Ut.bas]]` にある[[ファイル選択]]や[[フォルダ作成]]処理は、[[Pythonとは|Python]]の[[標準ライブラリ]]（`[[os]]`、`[[shutil]]`、`[[pathlib]]`）で容易に代替可能です。[[GUI]]が必要な場合は `[[tkinter]]` 等の検討が必要です。
    

### 4. まとめ

このツールは単なる[[データ転記]]ではなく、**[[Excel]]を「[[計算エンジン]]」として利用している**点が最大の特徴です。[[Pythonとは|Python化]]の際は、[[Excel VBAアプリ保守戦略|Excelアプリ]]を[[Pythonとは|Python]]から[[リモート操作]]する形（[[xlwingsとは|xlwings]]等）で実装するのが、既存の[[Excel計算ロジック]]をそのまま活かせるため、最もリスクの低い移行方法となります。
#VBA #Excelマクロ #Python移行 #GDMS連携 #自動化 #質量管理 #システム連携


